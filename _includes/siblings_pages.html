{% capture page_url -%}
  {% include helpers/pretty_url.html page=page %}
{%- endcapture %}
{% assign url_parts = page_url | split: "/" %}
{% assign url_prefix = "" %}
{% for url_part in url_parts %}
  {% if forloop.last == true and forloop.first == false %}
    {% continue %}
  {% elsif forloop.last == true and forloop.first == true %}
    {% assign url_prefix = "/" %}
    {% continue %}
  {% endif %}
  {% assign url_prefix = url_prefix |
       append: url_part |
       append: "/" %}
{% endfor %}

{% assign sibling_pages = site.pages |
     where_exp: "p", "p.url contains url_prefix" |
     sort: "position" %}
{% for sibling in sibling_pages %}

  {% if sibling.url == page.url %}{% continue %}{% endif %}

  {% capture sibling_url -%}
    {% include helpers/pretty_url.html page=sibling %}
  {%- endcapture %}
  {% assign url_parts_size_check = sibling_url | split: "/" | size %}
  {% if url_parts_size_check > url_parts.size %}
    {% continue %}
  {% endif %}

  <div class="items-row cols-1 row-0 row-fluid">
    <div class="span12">
      <div class="item column-1">
        {% if page.editable_elements['Page/Title image'] != false %}
          {% assign title_image_enabled = true %}
        {% else %}
          {% assign title_image_enabled = false %}
        {% endif %}
        {% if title_image_enabled and false %}
          <div class="item_img img-intro img-intro__left">
            <a href="{{ sibling.url | relative_url }}">
              {% comment %}
              TODO If this gets enabled, create new property with
              TODO thumbnail. Originally, resize filter with
              TODO argument '240x135#'.
              {% endcomment %}
              <img src="{{ child.editable_elements['Page/image'] | relative_url | default: "http://placehold.it/240x135" }}">
            </a>
          </div>
        {% endif %}

        <div class="item_header">
          <h4 class="item_title">
            <a href="{{ sibling.url | relative_url }}">{{ sibling.editable_elements['Page/Title'] | default: sibling.title }}</a>
          </h4>
        </div>
        <div class="item_introtext">
          {{ sibling.content | markdownify | strip_html | truncatewords: 50 }}
        </div>
      </div>
    </div>
  </div>
{% endfor %}
